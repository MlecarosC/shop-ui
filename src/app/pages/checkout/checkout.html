<div class="min-h-screen bg-base-100 py-12">
  <div class="max-w-7xl mx-auto px-6 md:px-10">
    
    <h1 class="text-4xl font-bold mb-8">Checkout</h1>

    @if (!cart() || cart()!.items.length === 0) {
      <div class="text-center py-20">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-24 w-24 mx-auto mb-4 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
        </svg>
        <h2 class="text-2xl font-bold mb-4">Tu carrito está vacío</h2>
        <p class="text-base-content/70 mb-8">Agrega productos para poder realizar una compra</p>
        <a routerLink="/products" class="btn btn-primary">Ver Productos</a>
      </div>
    } @else {
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <!-- Formulario de Checkout -->
        <div class="lg:col-span-2">
          <form [formGroup]="checkoutForm" class="space-y-8">
            
            <!-- Información de Facturación -->
            <div class="card bg-base-200 shadow-sm">
              <div class="card-body">
                <h2 class="card-title text-2xl mb-4">Información de Facturación</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  
                  <div class="form-control">
                    <label class="label">
                      <span class="label-text font-semibold">Nombre *</span>
                    </label>
                    <input 
                      type="text" 
                      formControlName="first_name"
                      placeholder="Tu nombre"
                      class="input input-bordered w-full"
                      [class.input-error]="isFieldInvalid('first_name')"
                    />
                    @if (isFieldInvalid('first_name')) {
                      <label class="label">
                        <span class="label-text-alt text-error">El nombre es requerido</span>
                      </label>
                    }
                  </div>

                  <div class="form-control">
                    <label class="label">
                      <span class="label-text font-semibold">Apellido *</span>
                    </label>
                    <input 
                      type="text" 
                      formControlName="last_name"
                      placeholder="Tu apellido"
                      class="input input-bordered w-full"
                      [class.input-error]="isFieldInvalid('last_name')"
                    />
                    @if (isFieldInvalid('last_name')) {
                      <label class="label">
                        <span class="label-text-alt text-error">El apellido es requerido</span>
                      </label>
                    }
                  </div>

                  <div class="form-control md:col-span-2">
                    <label class="label">
                      <span class="label-text font-semibold">Email *</span>
                    </label>
                    <input 
                      type="email" 
                      formControlName="email"
                      placeholder="tu@email.com"
                      class="input input-bordered w-full"
                      [class.input-error]="isFieldInvalid('email')"
                    />
                    @if (isFieldInvalid('email')) {
                      <label class="label">
                        <span class="label-text-alt text-error">Email válido es requerido</span>
                      </label>
                    }
                  </div>

                  <div class="form-control md:col-span-2">
                    <label class="label">
                      <span class="label-text font-semibold">Teléfono *</span>
                    </label>
                    <input 
                      type="tel" 
                      formControlName="phone"
                      placeholder="+56 9 1234 5678"
                      class="input input-bordered w-full"
                      [class.input-error]="isFieldInvalid('phone')"
                    />
                    @if (isFieldInvalid('phone')) {
                      <label class="label">
                        <span class="label-text-alt text-error">El teléfono es requerido</span>
                      </label>
                    }
                  </div>

                  <div class="form-control md:col-span-2">
                    <label class="label">
                      <span class="label-text font-semibold">País *</span>
                    </label>
                    <select
                      formControlName="country"
                      class="select select-bordered w-full"
                      [class.select-error]="isFieldInvalid('country')">
                      <option value="">Selecciona un país</option>
                      @for (country of countries; track country.code) {
                        <option [value]="country.code">{{ country.name }}</option>
                      }
                    </select>
                    @if (isFieldInvalid('country')) {
                      <label class="label">
                        <span class="label-text-alt text-error">El país es requerido</span>
                      </label>
                    }
                  </div>

                  <div class="form-control md:col-span-2">
                    <label class="label">
                      <span class="label-text font-semibold">Dirección *</span>
                    </label>
                    <input 
                      type="text" 
                      formControlName="address_1"
                      placeholder="Calle y número"
                      class="input input-bordered w-full"
                      [class.input-error]="isFieldInvalid('address_1')"
                    />
                    @if (isFieldInvalid('address_1')) {
                      <label class="label">
                        <span class="label-text-alt text-error">La dirección es requerida</span>
                      </label>
                    }
                  </div>

                  <div class="form-control">
                    <label class="label">
                      <span class="label-text font-semibold">Región *</span>
                    </label>
                    <input
                      type="text"
                      formControlName="state"
                      placeholder="Ingresa tu región"
                      class="input input-bordered w-full"
                      [class.input-error]="isFieldInvalid('state')"
                    />
                    @if (isFieldInvalid('state')) {
                      <label class="label">
                        <span class="label-text-alt text-error">La región es requerida</span>
                      </label>
                    }
                  </div>

                  <div class="form-control">
                    <label class="label">
                      <span class="label-text font-semibold">Ciudad *</span>
                    </label>
                    <input
                      type="text"
                      formControlName="city"
                      placeholder="Ingresa tu ciudad"
                      class="input input-bordered w-full"
                      [class.input-error]="isFieldInvalid('city')"
                    />
                    @if (isFieldInvalid('city')) {
                      <label class="label">
                        <span class="label-text-alt text-error">La ciudad es requerida</span>
                      </label>
                    }
                  </div>

                </div>
              </div>
            </div>

            <!-- Método de Pago -->
            <div class="card bg-base-200 shadow-sm">
              <div class="card-body">
                <h2 class="card-title text-2xl mb-4">Método de Pago</h2>
                
                @if (!isAuthenticated()) {
                  <div class="alert alert-warning mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                    <div>
                      <h3 class="font-bold">Debes iniciar sesión</h3>
                      <div class="text-xs">Para procesar el pago necesitas estar autenticado</div>
                    </div>
                    <a [routerLink]="['/login']" [queryParams]="{returnTo: 'checkout'}" class="btn btn-sm">Iniciar Sesión</a>
                  </div>
                }

                <div class="space-y-3">
                  <div class="form-control">
                    <label class="label cursor-pointer justify-start gap-4 p-4 bg-base-100 rounded-lg hover:bg-base-300 transition-colors">
                      <input
                        type="radio"
                        formControlName="paymentMethod"
                        value="mercadopago"
                        class="radio radio-primary"
                      />
                      <div class="flex items-center gap-3">
                        <div class="bg-white p-2 rounded flex items-center justify-center w-12 h-12">
                          <svg width="32" height="32" viewBox="0 0 256 256" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="128" cy="128" r="128" fill="#009EE3"/>
                            <path d="M128 60C90.1 60 60 90.1 60 128s30.1 68 68 68 68-30.1 68-68-30.1-68-68-68zm0 120c-28.7 0-52-23.3-52-52s23.3-52 52-52 52 23.3 52 52-23.3 52-52 52z" fill="white"/>
                            <circle cx="128" cy="128" r="32" fill="white"/>
                          </svg>
                        </div>
                        <div>
                          <span class="label-text font-semibold">Mercado Pago</span>
                          <p class="text-xs text-base-content/70">Paga con tarjeta de crédito o débito</p>
                        </div>
                      </div>
                    </label>
                  </div>

                  <div class="form-control">
                    <label class="label cursor-pointer justify-start gap-4 p-4 bg-base-100 rounded-lg hover:bg-base-300 transition-colors">
                      <input
                        type="radio"
                        formControlName="paymentMethod"
                        value="transbank"
                        class="radio radio-primary"
                      />
                      <div class="flex items-center gap-3">
                        <div class="bg-white p-2 rounded flex items-center justify-center w-12 h-12">
                          <svg width="32" height="32" viewBox="0 0 256 256" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <rect width="256" height="256" rx="16" fill="#E30613"/>
                            <path d="M60 100h136v16H60v-16zm0 28h136v16H60v-16zm0 28h136v16H60v-16z" fill="white"/>
                            <path d="M100 60h56v28h-56V60z" fill="white"/>
                            <circle cx="80" cy="74" r="10" fill="white"/>
                            <circle cx="176" cy="74" r="10" fill="white"/>
                          </svg>
                        </div>
                        <div>
                          <span class="label-text font-semibold">Transbank Webpay</span>
                          <p class="text-xs text-base-content/70">Paga con tarjetas chilenas</p>
                        </div>
                      </div>
                    </label>
                  </div>
                </div>

                @if (checkoutForm.get('paymentMethod')?.touched && !checkoutForm.get('paymentMethod')?.value) {
                  <label class="label">
                    <span class="label-text-alt text-error">Debes seleccionar un método de pago</span>
                  </label>
                }
              </div>
            </div>

            <!-- Términos y Condiciones -->
            <div class="alert alert-info">
              <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-5 w-5" fill="none" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <span class="text-sm">
                Al realizar tu compra, aceptas nuestros <a href="#" class="link link-primary font-semibold">términos y condiciones</a>
              </span>
            </div>

          </form>
        </div>

        <!-- Resumen del Pedido -->
        <div class="lg:col-span-1">
          <div class="card bg-base-200 shadow-sm sticky top-4">
            <div class="card-body">
              <h2 class="card-title text-2xl mb-4">Resumen del Pedido</h2>
              
              <div class="space-y-4 mb-6">
                @for (item of cart()!.items; track item.item_key) {
                  <div class="flex gap-3">
                    <figure class="w-16 h-16 flex-shrink-0 rounded overflow-hidden bg-base-100">
                      <img 
                        [src]="item.featured_image" 
                        [alt]="item.name"
                        class="w-full h-full object-cover"
                      />
                    </figure>
                    <div class="flex-1 min-w-0">
                      <h3 class="font-semibold text-sm line-clamp-2">{{ item.name }}</h3>
                      <p class="text-xs text-base-content/70">Cantidad: {{ item.quantity.value }}</p>
                      <p class="text-primary font-bold text-sm mt-1">{{ item.price | currency }}</p>
                    </div>
                  </div>
                }
              </div>

              <div class="divider my-2"></div>

              <div class="space-y-2 mb-4">
                <div class="flex justify-between text-sm">
                  <span class="text-base-content/70">Subtotal:</span>
                  <span class="font-semibold">{{ cart()!.totals.subtotal | currency }}</span>
                </div>
                
                @if (cart()!.totals.total_tax !== '0') {
                  <div class="flex justify-between text-sm">
                    <span class="text-base-content/70">Impuestos:</span>
                    <span class="font-semibold">{{ cart()!.totals.total_tax | currency }}</span>
                  </div>
                }
                
                <div class="divider my-2"></div>
                
                <div class="flex justify-between text-lg">
                  <span class="font-bold">Total:</span>
                  <span class="font-bold text-primary">{{ cart()!.totals.total | currency }}</span>
                </div>
              </div>

              @if (!isAuthenticated()) {
                <div class="alert alert-warning text-sm mb-4">
                  <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-5 w-5" fill="none" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                  </svg>
                  <span>Debes iniciar sesión para procesar el pago</span>
                </div>
              }

              @if (isAuthenticated() && !checkoutForm.get('paymentMethod')?.value) {
                <div class="alert alert-info text-sm mb-4">
                  <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-5 w-5" fill="none" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  <span>Selecciona un método de pago</span>
                </div>
              }

              <button
                (click)="processOrder()"
                [disabled]="!canProcessOrder()"
                class="btn btn-primary btn-block btn-lg">
                @if (isProcessing()) {
                  <span class="loading loading-spinner"></span>
                  Procesando...
                } @else {
                  Confirmar Pedido
                }
              </button>

              <p class="text-xs text-center text-base-content/70 mt-4">
                Tu pago se procesará de forma segura
              </p>
            </div>
          </div>
        </div>

      </div>
    }

  </div>
</div>
